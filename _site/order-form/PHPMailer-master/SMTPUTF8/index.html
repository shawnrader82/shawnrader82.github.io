<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>A short history of UTF-8 in email | Mobile American Notary &amp; Apostilles</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="A short history of UTF-8 in email" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Expert mobile notary and apostille services in Los Angeles" />
<meta property="og:description" content="Expert mobile notary and apostille services in Los Angeles" />
<link rel="canonical" href="https://www.mobileamericannotary.com/order-form/PHPMailer-master/SMTPUTF8/" />
<meta property="og:url" content="https://www.mobileamericannotary.com/order-form/PHPMailer-master/SMTPUTF8/" />
<meta property="og:site_name" content="Mobile American Notary &amp; Apostilles" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="A short history of UTF-8 in email" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Expert mobile notary and apostille services in Los Angeles","headline":"A short history of UTF-8 in email","url":"https://www.mobileamericannotary.com/order-form/PHPMailer-master/SMTPUTF8/"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=25e4484b7be4f455a1cd22839780f597750c42df">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="https://www.mobileamericannotary.com/">Mobile American Notary & Apostilles</a></h1>
      

      <h1 id="a-short-history-of-utf-8-in-email">A short history of UTF-8 in email</h1>

<h2 id="background">Background</h2>

<p>For most of its existence, SMTP has been a 7-bit channel, only supporting US-ASCII characters. This has been a problem for many languages, especially those that use non-Latin scripts, and has led to the development of various workarounds.</p>

<p>The first major improvement, introduced in 1994 in <a href="https://www.rfc-editor.org/rfc/rfc1652">RFC 1652</a> and extended in 2011 in <a href="https://www.rfc-editor.org/rfc/rfc6152">RFC 6152</a>, was the addition of the <code class="language-plaintext highlighter-rouge">8BITMIME</code> SMTP extension, which allowed raw 8-bit data to be included in message bodies sent over SMTP.
This allowed the message <em>contents</em> to contain 8-bit data, including things like UTF-8 text, even though the SMTP protocol itself was still firmly 7-bit. This worked by having the server switch to 8-bit after the headers, and then back to 7-bit after the completion of a <code class="language-plaintext highlighter-rouge">DATA</code> command.</p>

<p>From 1996, messages could support <a href="https://www.rfc-editor.org/rfc/rfc2047">RFC 2047 encoding</a>, which permitted inserting characters from any character set into header <em>values</em> (but not names), but only by encoding them in somewhat unreadable ways to allow them to survive passage through a 7-bit channel. An example with a subject of ‚ÄúSchr√∂dinger‚Äôs cat‚Äù would be:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Subject: =?utf-8?Q=Schr=C3=B6dinger=92s_Cat?=
</code></pre></div></div>

<p>Here the accented <code class="language-plaintext highlighter-rouge">√∂</code> is encoded as <code class="language-plaintext highlighter-rouge">=C3=B6</code>, which is the UTF-8 encoding of the 2-byte character, and the whole thing is wrapped in <code class="language-plaintext highlighter-rouge">=?utf-8?Q?</code> to indicate that it uses the UTF-8 charset and <code class="language-plaintext highlighter-rouge">quoted-printable</code> encoding. This is a bit of a hack, and not very human-friendly, but it works.</p>

<p>Similarly, 8-bit message bodies could be encoded using the same <code class="language-plaintext highlighter-rouge">quoted-printable</code> and <code class="language-plaintext highlighter-rouge">base64</code> content transfer encoding (CTE) schemes, which preserved the 8-bit content while encoding it in a format that could survive transmission through a 7-bit channel.</p>

<p>Domain names were originally also stuck in a 7-bit world, actually even more constrained to only a subset of the US-ASCII character set. But of course, many people want to have domains in their own language/script. Internationalized domain name (IDN) permitted this, using yet another complex encoding scheme called punycode, defined for domain names in 2003 in <a href="https://www.rfc-editor.org/rfc/rfc3492">RFC 3492</a>. This finally allowed the domain part (after the <code class="language-plaintext highlighter-rouge">@</code>) of email addresses to contain UTF-8, though it was actually an illusion preserved by email client applications. For example, an address of
<code class="language-plaintext highlighter-rouge">user@caf√©.example.com</code> translates to
<code class="language-plaintext highlighter-rouge">user@xn--caf-dma.example.com</code> in punycode, rendering it mostly unreadable, but 7-bit friendly, and remaining compatible with email clients that don‚Äôt know about IDN.</p>

<p>The one remaining part of email that could not handle UTF-8 is the local part of email addresses (the part before the <code class="language-plaintext highlighter-rouge">@</code>).</p>

<p>I‚Äôve only mentioned UTF-8 here, but most of these approaches also allowed other character sets that were popular, such as <a href="https://en.wikipedia.org/wiki/ISO/IEC_8859">the ISO-8859 family</a>. However, UTF-8 solves so many problems that these other character sets are gradually falling out of favour, as UTF-8 can support all languages.</p>

<p>This patchwork of overlapping approaches has served us well, but we have to admit that it‚Äôs a mess.</p>

<h2 id="smtputf8">SMTPUTF8</h2>

<p><code class="language-plaintext highlighter-rouge">SMTPUTF8</code> is another SMTP extension, defined in <a href="https://www.rfc-editor.org/rfc/rfc6531">RFC 6531</a> in 2012. This essentially solves the whole problem, allowing the entire SMTP conversation ‚Äî commands, headers, and message bodies ‚Äî to be sent in raw, unencoded UTF-8.</p>

<p>But there‚Äôs a problem with this approach: adoption. If you send a UTF-8 message to a recipient whose mail server doesn‚Äôt support this format, the sender has to somehow downgrade the message to make it survive a transition to 7-bit. This is a hard problem to solve, especially since there is no way to make a 7-bit system support UTF-8 in the local parts of addresses. This downgrade problem is what held up the adoption of <code class="language-plaintext highlighter-rouge">SMTPUTF8</code> in PHPMailer for many years, but in that time the <em>de facto</em> approach has become to simply fail in that situation, and tell the recipient it‚Äôs time they upgraded their mail server üòÖ.</p>

<p>The vast majority of large email providers (gmail, Yahoo, Microsoft, etc), mail servers (postfix, exim, IIS, etc), and mail clients (Apple Mail, Outlook, Thunderbird, etc) now all support SMTPUTF8, so the need for backward compatibility is no longer what it was.</p>

<h2 id="smtputf8-in-phpmailer">SMTPUTF8 in PHPMailer</h2>

<p>Several other PHP email libraries have implemented a halfway solution to <code class="language-plaintext highlighter-rouge">SMTPUTF8</code>, adding only the ability to support UTF-8 in email addresses, not elsewhere in the protocol. I wanted PHPMailer to do it ‚Äúthe right way‚Äù, and this has taken much longer. PHPMailer now supports UTF-8 everywhere, and does not need to use transfer or header encodings for UTF-8 text when connecting to an <code class="language-plaintext highlighter-rouge">SMTPUTF8</code>-capable mail server.</p>

<p>This support is handled automatically: if you add an email address that requires UTF-8, PHPMailer will use UTF-8 for everything. If not, it will fall back to 7-bit and encode the message as necessary.</p>

<p>The one place you will need to be careful is in the selection of the address validator. By default, PHPMailer uses PHP‚Äôs built-in <code class="language-plaintext highlighter-rouge">filter_var</code> validator, which does not allow UTF-8 email addresses. When PHPMailer spots that you have submitted a UTF-8 address, but have not altered the default validator, it will automatically switch to using a UTF-8-compatible validator. As soon as you do this, any SMTP connection you make will <em>require</em> that the server you connect to supports <code class="language-plaintext highlighter-rouge">SMTPUTF8</code>. You can select this validator explicitly by setting <code class="language-plaintext highlighter-rouge">PHPMailer::$validator = 'eai'</code> (an acronym for Email Address Internationalization).</p>

<h3 id="postfix-gotcha">Postfix gotcha</h3>

<p>Postfix has supported <code class="language-plaintext highlighter-rouge">SMTPUTF8</code> for a long time, but it has a peculiarity that it does not always advertise that it does so. However, rather surprisingly, if you use UTF-8 in the conversation, it will work anyway.</p>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
